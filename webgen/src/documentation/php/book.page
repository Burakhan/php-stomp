---
title: PHP Stomp Client User Guide
--- name:head pipeline:tags
<link href="{relocatable: /styles/book.css}" rel="stylesheet" type="text/css" />

--- name:content pipeline:tags,asciidoc

{title:}
===========================
Dejan Bosanac
v1.0, Aug 2009

Introduction
------------

This project is a PHP Stomp clients that besides it implements the Stomp protocol fully, adds some ActiveMQ specific features that could make your messaging from PHP easier.

Getting Started
---------------

Obtain the source of the library by downloading the distribution and add its content to your `include_path`. Alternatively, you can grab the source and add `src/main` folder to your `include_path`.

Examples are located in `src/examples` folder. Before running them, be sure you have installed this library properly and you have started ActiveMQ broker (recommended version 5.3.0) with Stomp connector enabled (http://activemq.apache.org/stomp.html). 

You can start the first example by running 
	
	cd examples
	php first.php
	
Also, be sure to check comments in the particular examples for some special configuration steps (if needed).

First Example
-------------

The simplest example shows how you can connect to the ActiveMQ message broker and send/receive a message from the queue.

    <?
    // include a library
    require_once("Stomp.php");
    // make a connection
    $con = new Stomp("tcp://localhost:61613");
    // connect
    $con->connect();
    // send a message to the queue
    $con->send("/queue/test", "test");
    echo "Sent message with body 'test'\n";
    // subscribe to the queue
    $con->subscribe("/queue/test");
    // receive a message from the queue
    $msg = $con->readFrame();

    // do what you want with the message
    if ( $msg != null) {
        echo "Received message with body '$msg->body'\n";
        // mark the message as received in the queue
        $con->ack($msg);
    } else {
        echo "Failed to receive a message\n";
    }

    // disconnect
    $con->disconnect();
    ?>

After the execution this script should print

    $ php first.php 
    Sent message with body 'test'
    Received message with body 'test'

and it shows how easy it is to do asynchronous messaging using Stomp.

Transactions
------------

Stomp transactions allow you to send messages and acknowledgments in atomic operations. For more information on transactions, take a look at the following article http://activemq.apache.org/stomp/stomp10/additional.html#transaction_handling.

Now let's go through the basics of transaction usage in PHP Stomp client. To start the transaction, you should use `begin()` method with transaction id as a parameter.

    $stomp->begin("tx1");

In the similar way you can commit or abort your transactions

    $con->commit("tx1");    
    $stomp->abort("tx1");
    
To send a message in a transaction, you should pass an extra `transaction` header, like this
        
    $stomp->send("/queue/transactions", "message text", array("transaction" => "tx1"));

To send an acknowledgment in a transaction, pass transaction id as an extra argument to the `ack()` method, like this    

    $stomp->ack($message, "tx1");

The full example of the transaction usage with PHP Stomp client can be found in `examples/transactions.php`.

Durable Subscribers
-------------------

Durable topic subscribers are not part of the Stomp protocol, but an ActiveMQ feature that allow topic subscribers to receive messages sent to the topic while there were offline (http://activemq.apache.org/how-do-durable-queues-and-topics-work.html).

Stomp protocol implementation in ActiveMQ enables this feature for Stomp subscribers as well. To use this feature, first you need to define a client id your consumer will use, like this

    $consumer = new Stomp("tcp://localhost:61613");
    $consumer->clientId = "test";
    
Next, you client need to provide this id while subscribing to the topic. This is done by passing special `activemq.subcriptionName` header along with the `SUBSCRIBE` frame. But once, you've set the client id to your consumer, PHP Stomp client will do this work for you. So you can subscribe to the topic, just as you'd normally do

    $consumer->subscribe("/topic/test");
    
One more important thing is that you need to send persistent messages to the topic in you want them delivered to the delivered to the durable consumers that are currently offline. You can do that by passing a `persistent` header along with your messages

    $producer->send("/topic/test", "test1", array('persistent'=>'true'));

The full example of the PHP Stomp client durable subscribers can be found in `examples/durable.php`.

Connectivity
------------

This Stomp client supports various connectivity methods helping you achieve more flexibility in how you connect to your broker (or brokers)

Failover
~~~~~~~~

The Failover transport allows you to set URIs of multiple brokers and define basic parameters of how the client should attempt to connect to those brokers (in case it fails to connect for the first time). More information on the Failover transport and how ActiveMQ implements it could be found at the following URL (http://activemq.apache.org/failover-transport-reference.html).

PHP Stomp client uses the same configuration syntax as ActiveMQ. So instead of connecting to the broker by using standard broker URL, such as

    $this->con = new Stomp("tcp://localhost:61613");

you can use composite URLs. For example

    $this->con = new Stomp("failover://(tcp://localhost:61614,tcp://localhost:61613)?randomize=false");

Now instead of trying to connect to the single broker, the client will execute reconnection logic if needed. For the previous example, if we don't have a broker connector running on port `61614` it will try to connect on port `61613`. If you look at PHP , you'll find messages similar to these

    Warning: fsockopen(): unable to connect to tcp://localhost:61614 (Connection refused) in
     /home/dejan/development/stomp/src/main/php4/Stomp.php on line 201
    
    Warning: Could not connect to localhost:61614 (1/10) in 
    /home/dejan/development/stomp/src/main/php4/Stomp.php on line 204
    
This connectivity option allows you to use this client in a link:http://activemq.apache.org/clustering.html[clustered broker environment]

Currently, you can only use the `randomize` parameter to specify whether you want to use random algorithm when choosing broker from the list. The client will try to connect `10` time before it fails. The more connection options will be implemented soon.

SSL
~~~

You can instruct this client to use SSL when connecting to brokers that support this feature. For example, you can add another transport connector for ActiveMQ like this

    <transportConnector name="stomp+ssl" uri="stomp+ssl://localhost:61612"/>

and then you can connect to it by using the following syntax for the broker URL

    $this->con = new Stomp("ssl://localhost:61612");

SSL connections can be used as a part of failover URLs. For example

    $this->con = new Stomp("failover://(tcp://localhost:61614,ssl://localhost:61612)?randomize=false");
    
The full example of the PHP Stomp client connectivity options can be found in `examples/connectivity.php`.

[[handling-errors]]
Handling Errors
---------------
[[synchronous-operations]]
Synchronous Operations
~~~~~~~~~~~~~~~~~~~~~~

By default this client is configured to work in a synchronous mode, which means that for every command (except `CONNECT`) the client will wait for the [receipt | Protocol#RECEIPT]. You can set the client to work in the asynchronous mode, by setting the `sync` property of the `StompConnection` object to `false`.

    $conn = new Stomp("tcp://localhost:61613");
    $conn->sync = false;

You can also perform single operations in desired mode, no matter of the global client settings, by passing additional parameter to the appropriate method

    $this->conn->send("/queue/test", "test", null, true);

Some things you have to consider when deciding whether to use synchronous or asynchronous mode
* When you use asynchronous mode broker errors will be ignored
* Asynchronous method allows you to send messages faster, since will not wait for broker's response

Exceptions
~~~~~~~~~~

TODO

Security
--------

PHP client is able to work with secured brokers, correctly applying their authentication and authorization policies. For more information on how to secure ActiveMQ broker see http://activemq.apache.org/security.html.

Authentication
~~~~~~~~~~~~~~
When connecting to the broker you can specify username and password which will be used to check your privileges against broker's security mechanism.

    if (!$conn->connect("dejanb", "test123")) {
	    echo $conn->error . " - " . $conn->exception;
	    trigger_error("Connection failed", E_USER_ERROR);
    }

In case of unsuccessful authentication, the `connect()` method will fail.

    User name or password is invalid. - java.lang.SecurityException: User name or password is invalid.
        at org.apache.activemq.security.SimpleAuthenticationBroker.addConnection(SimpleAuthenticationBroker.java:52)
        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:81)
        at org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:91)
        at org.apache.activemq.broker.TransportConnection.processAddConnection(TransportConnection.java:656)
        at org.apache.activemq.broker.jmx.ManagedTransportConnection.processAddConnection(ManagedTransportConnection.java:86)
        at org.apache.activemq.command.ConnectionInfo.visit(ConnectionInfo.java:125)
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:280)
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:177)
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)
        at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:79)
        at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:128)
        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompConnect(ProtocolConverter.java:437)
        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommad(ProtocolConverter.java:163)
        at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:69)
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:189)
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:176)
        at java.lang.Thread.run(Thread.java:595)


For more information on how to handle exceptions, see <<handling-errors, handling errors>>.


Authorization
~~~~~~~~~~~~~

If you use <<synchronous-operations,synchronous operations>> you can handle authorization errors when you try to access (read/write) certain destinations.

    if (!$conn->send("/queue/test", "test")) {
	    echo $conn->error . " - " . $conn->exception;
	    trigger_error("Sending failed", E_USER_ERROR);
    }

In case of error, you can expect the following output

    User guest is not authorized to write to: queue://test - 
    java.lang.SecurityException: User guest is not authorized to write to: queue://test
        at org.apache.activemq.security.AuthorizationBroker.send(AuthorizationBroker.java:173)
        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135)
        at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:433)
        at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:623)
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:280)
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:177)
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)
        at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:79)
        at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:128)
        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompSend(ProtocolConverter.java:222)
        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommad(ProtocolConverter.java:149)
        at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:69)
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:189)
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:176)
        at java.lang.Thread.run(Thread.java:595)User guest is not authorized to read from: queue://test
    User guest is not authorized to read from: queue://test

For more information on how to handle exceptions, see <<handling-errors, handling errors>>.
